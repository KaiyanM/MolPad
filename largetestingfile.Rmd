---
title: "large_testing_file"
author: "mky"
date: "2023-10-12"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# 1

```{r}
test1 <- function(processed_annotation, processed_data, cluster_output) {
  processed_data |>
    mutate(cluster = paste0("Group_", cluster_output[[1]]$cluster)) |>
    select(c("ID", "cluster")) |>
    merge(processed_annotation, by = "ID", all.x = TRUE)
}

test <- test1(pathchee,cheesedata,cluschee)

test2_dfgroup_long <- function(processed_data, clusters_output, processed_annotation) {
  maindata <- processed_data |>
    mutate(cluster = paste0("Group_", clusters_output[[1]]$cluster)) |>
    pivot_longer(
      c(-ID, -cluster, -type),
      names_to = "day",
      values_to = "value"
    ) |>
    mutate(day = factor(day, levels = colnames(processed_data)[c(-1, -ncol(processed_data))])) |>
    left_join(select(processed_annotation, ID, taxonomic.scope), by = "ID")

  maindata$taxonomic.scope[is.na(maindata$taxonomic.scope)] <- "No Label"
  maindata
}

test2_dfgroup_long(cheesedata,cluschee,pathchee)


intermediate_variable_generator <- function(processed_annotation, processed_data, cluster_output, network_output){
  ivs <- list()
  #对齐数量（na）
  ptw <- processed_data |>
    mutate(cluster = paste0("Group_", cluster_output[[1]]$cluster))|>
    merge(processed_annotation, by = "ID", all.x = TRUE)
  
}



```

```{r}

pathchee <- gAnnotation(annotations,phylum,class,KEGG_ID)

summary(as.factor(pathchee$taxonomic.scope))
```



# dashboard



```{r}
data('cheese')

```

```{r}
annotations <- merge(f12,t12,by="ID")

cheese <- c12

save(cheese,annotations,file="cheese.RData")
```


# 2
```{r}
data("cheese")
data("test_data")
library(MolPad)

cheesedata <- cheese |>
  dplyr::mutate(annotations["kingdom"]) |>
  dplyr::rename(type=kingdom) |> 
  pre_process()


cluschee <- gClusters(cheesedata,ncluster = 10,elbow.max=15)

networkchee <- gNetwork(cluschee,ntop = 3)

pathchee <- gAnnotation(annotations,phylum,class)

gDashboard(cheesedata,cluschee,pathchee,networkchee,dashboardtitle = "Test",id_colname = c("GO_ID","KEGG_ID"),id_type = c("GO","KEGG"))

#-----
library(shinydashboard)

```


```{r}
reshape_for_make_functions1 <- function(data, cluster, annotation, id_colname, id_type) {
  
  data_cluster <- data |>
    mutate(cluster = paste0("Group_", cluster[[1]]$cluster)) 
  
  #ptw: id cluster columns in annotation
  output_graphptw <- data_cluster |>
    select(c("ID", "cluster")) |>
    merge(annotation, by = "ID", all.x = TRUE)
  
  #dfgroup_long: id type cluster day value taxonomic.scope
  output_maindata <- data_cluster |>
    pivot_longer(
      c(-ID, -cluster, -type),
      names_to = "day",
      values_to = "value"
    ) |>
    mutate(day = factor(day, levels = colnames(data)[c(-1, -ncol(data))])) |>
    left_join(select(annotation, ID, taxonomic.scope), by = "ID")
  
  output_tableview <- output_graphptw 
    #na.omit()
    #match_database(id_colname,id_type)
  

  #output_tableview$web_id <- paste_URL(output_tableview$web_id,id_type)
  
  list(output_graphptw = output_graphptw,
       output_maindata = output_maindata,
       output_tableview = output_tableview)

}

test <- reshape_for_make_functions1(cheesedata,cluschee,pathchee,id_colname = c("GO_ID","web_id"),id_type = c("GO","KEGG"))[[3]]
test[["GO_ID"]]

match_database(test[["KEGG_ID"]],id_type="KEGG")

paste_URL(test[["KEGG_ID"]],id_type="KEGG")
```


```{r}
test<-pathchee[1:13,]
test$GO_ID

match_database <- function(data,id_colname,id_type){
  if(length(id_colname)!=length(id_type)){
    print("id_colname and id_type must have the same length.")
  }else{
    for (i in 1:length(id_colname)) {
      data[[id_colname[i]]] <-  paste_URL(data[[id_colname[i]]],id_type[i])
    }
    data
  }
}

rm(match_database)
test1 <- c("kk","uu")
test1[1]
match_database(test,id_colname = c("GO_ID","web_id"),id_type = c("GO","KEGG"))

str_extract_all(test$GO_ID,"GO:\\d{7}")
paste_URL(test$GO_ID,"GO")

output_tableview$web_id <- paste_URL(output_tableview$web_id,id_type)
```


```{r}
test<-pathchee[1:10,c(1,3)]
test

gsub("K\\d{5}","link",test$web_id)
grep("K\\d{5}",test$web_id,value=TRUE)

paste0("<a href='", output_tableview$web_id, "' target='_blank'>", output_tableview$web_id, "</a>")


str_extract(test$web_id,"K\\d{5}")

test1 <- test$web_id[7]
test1
length(str_extract_all(test$web_id,"K\\d{5}")[[7]])
library(stringr)
paste0("<a href='",str_extract_all(test$web_id,"K\\d{5}"),"' target='_blank'>","</a>")

paste_URL <- function(x,id_type){
  output_list <- c()
  if(id_type=="KEGG"){
    extract_multiple_id <- str_extract_all(x,"K\\d{5}")
    link <- "https://www.kegg.jp/entry/"
  }else if(id_type=="GO"){
    extract_multiple_id <- str_extract_all(x,"GO:\\d{7}")
    link <- "https://www.ebi.ac.uk/QuickGO/term/"
  }else{
    print("ID must be one of the following: KEGG, GO")
  }
  for (i in 1:length(extract_multiple_id)) {
    if(length(extract_multiple_id[[i]]) != 0){
      for (j in 1:length(extract_multiple_id[[i]])) {
        extract_multiple_id[[i]][j] <- paste0("<a href='",link,extract_multiple_id[[i]][j],"' target='_blank'>",extract_multiple_id[[i]][j],"</a>")
      }
      output_list[i] <- paste(extract_multiple_id[[i]], collapse = '<br/>')
    }
  }
  output_list
}

rm(paste_URL)
test$web_id 
  
paste_URL(test$web_id,"KEGG")

test

test
lapply(test$web_id, paste_URL)
```



```{r}
test <- gPathway(pathchee, cheesedata, cluschee)



annotation_hyperlink2(test,id_type = "KEGG")

gMainData(cheesedata, cluschee, pathchee)

gMainData.test <- function(gpathway_output) {
  maindata <- gpathway_output |>
    pivot_longer(
      c(-ID, -cluster, -type),
      names_to = "day",
      values_to = "value"
    ) |>
    mutate(day = factor(day, levels = colnames(data)[c(-1, -ncol(data))])) |>
    left_join(select(pathway, ID, taxonomic.scope), by = "ID")

  maindata$taxonomic.scope[is.na(maindata$taxonomic.scope)] <- "No Label"
  maindata
}

gMainData.test(test)
```



# reshape
```{r}
reshape_for_make_functions(cheesedata,cluschee,pathchee,"KEGG")

```

# write test
```{r}
set.seed(123)

test_data <- cbind("ID"=1:100,cheese[sample(1:10000,100),c(2:6)],cheese[sample(10000:20000,100),c(2:6)],"type"=c(rep("type_A",20),rep("type_B",20),rep("type_C",10),rep("type_D",50)))
test_data
rownames(test_data) <- c()
colnames(test_data)[2:11] <- paste0("T",1:10)



test_annotations <- cbind("ID"=1:100,annotations[sample(1:10000,100),c(2:3)],"system"=rep(c('Integumentary System', 'Skeletal System', 'Muscular System', 'Nervous System', 'Endocrine System', 'Cardiovascular System', 'Lymphatic System', 'Respiratory System', 'Digestive System', 'Urinary System'),10),"class"=sample(c(rep(c('antibodies', 'contractile proteins', 'enzymes'),each=20),rep(c('hormonal proteins', 'structural proteins', 'storage proteins', 'transport proteins'),each=10))))
rownames(test_annotations) <- c()

test_data_processed <- test_data |>
  pre_process()

test_cluster <- gClusters(test_data_processed,ncluster = 5,elbow.max=15)
test_network <- gNetwork(test_cluster,ntop = 3)
test_network
test_cluster
# data col must greater than 5

test_annotations_processed <- gAnnotation(test_annotations,system,class)
test_annotations_processed

gDashboard(test_data_processed,test_cluster,test_annotations_processed,test_network,dashboardtitle = "Test",id_colname = c("GO_ID","KEGG_ID"),id_type = c("GO","KEGG"))
#99-pathway error

save(test_data,test_data_processed,
     test_annotations,test_annotations_processed,
     test_cluster,test_network,file="test_data.RData")
```

